// Database Documentation - ACTO Maps
// DBML (Database Markup Language) Specification

Project acto_maps {
  database_type: 'PostgreSQL'
  Note: 'Sistema de gerenciamento de camadas geoespaciais com PostGIS'
}

// Users Table
Table users {
  id bigserial [pk, increment]
  name varchar(255) [not null]
  email varchar(255) [unique, not null]
  email_verified_at timestamp [null]
  password varchar(255) [not null, note: 'Argon2ID hash']
  two_factor_secret text [null, note: 'Encrypted TOTP secret']
  two_factor_recovery_codes text [null, note: 'Encrypted recovery codes']
  remember_token varchar(100) [null]
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  
  Indexes {
    email [name: 'idx_users_email']
    created_at [name: 'idx_users_created']
  }
  
  Note: 'User accounts with 2FA support'
}

// Roles Table (Laravel Permission)
Table roles {
  id bigserial [pk, increment]
  name varchar(255) [unique, not null]
  guard_name varchar(255) [not null, default: 'web']
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  
  Indexes {
    (name, guard_name) [unique, name: 'roles_name_guard_unique']
  }
  
  Note: 'Roles: admin, operator, viewer'
}

// Permissions Table (Laravel Permission)
Table permissions {
  id bigserial [pk, increment]
  name varchar(255) [unique, not null]
  guard_name varchar(255) [not null, default: 'web']
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  
  Indexes {
    (name, guard_name) [unique, name: 'permissions_name_guard_unique']
  }
  
  Note: 'Permissions: view_layer, create_layer, edit_layer, delete_layer, manage_users'
}

// Model Has Roles (Pivot)
Table model_has_roles {
  role_id bigint [ref: > roles.id, not null]
  model_type varchar(255) [not null]
  model_id bigint [not null]
  
  Indexes {
    (role_id, model_id, model_type) [pk, name: 'model_has_roles_pkey']
    model_id [name: 'idx_model_has_roles_model']
  }
  
  Note: 'Polymorphic pivot table for user roles'
}

// Model Has Permissions (Pivot)
Table model_has_permissions {
  permission_id bigint [ref: > permissions.id, not null]
  model_type varchar(255) [not null]
  model_id bigint [not null]
  
  Indexes {
    (permission_id, model_id, model_type) [pk, name: 'model_has_permissions_pkey']
    model_id [name: 'idx_model_has_permissions_model']
  }
  
  Note: 'Polymorphic pivot table for direct user permissions'
}

// Role Has Permissions (Pivot)
Table role_has_permissions {
  permission_id bigint [ref: > permissions.id, not null]
  role_id bigint [ref: > roles.id, not null]
  
  Indexes {
    (permission_id, role_id) [pk, name: 'role_has_permissions_pkey']
    role_id [name: 'idx_role_has_permissions_role']
  }
  
  Note: 'Pivot table linking roles to permissions'
}

// Layers Table (Main Entity)
Table layers {
  id bigserial [pk, increment]
  name varchar(255) [not null]
  description text [null]
  type varchar(50) [not null, note: 'point, line, polygon']
  source varchar(500) [null, note: 'URL or S3 path to layer file']
  geometry geometry [null, note: 'PostGIS geometry column']
  metadata jsonb [null, note: 'Additional layer metadata']
  is_active boolean [not null, default: true]
  created_by bigint [ref: > users.id, not null]
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  deleted_at timestamp [null, note: 'Soft delete']
  
  Indexes {
    name [name: 'idx_layers_name']
    is_active [name: 'idx_layers_is_active']
    created_by [name: 'idx_layers_created_by']
    geometry [type: gist, name: 'idx_layers_geometry_gist']
    created_at [name: 'idx_layers_created_at']
    deleted_at [name: 'idx_layers_deleted_at']
  }
  
  Note: 'Map layers with geospatial data'
}

// Sessions Table
Table sessions {
  id varchar(255) [pk]
  user_id bigint [ref: > users.id, null]
  ip_address varchar(45) [null]
  user_agent text [null]
  payload text [not null]
  last_activity integer [not null]
  
  Indexes {
    user_id [name: 'idx_sessions_user']
    last_activity [name: 'idx_sessions_last_activity']
  }
  
  Note: 'User sessions storage'
}

// Audit Logs Table
Table audit_logs {
  id bigserial [pk, increment]
  user_id bigint [ref: > users.id, null]
  action varchar(50) [not null, note: 'create, update, delete, view']
  model varchar(100) [not null, note: 'Layer, User, etc']
  model_id bigint [null]
  old_values jsonb [null]
  new_values jsonb [null]
  ip_address inet [null]
  user_agent text [null]
  created_at timestamp [default: `now()`]
  
  Indexes {
    user_id [name: 'idx_audit_user']
    (model, model_id) [name: 'idx_audit_model']
    created_at [name: 'idx_audit_created']
    action [name: 'idx_audit_action']
  }
  
  Note: 'Audit trail for all critical actions'
}

// Personal Access Tokens (Laravel Sanctum)
Table personal_access_tokens {
  id bigserial [pk, increment]
  tokenable_type varchar(255) [not null]
  tokenable_id bigint [not null]
  name varchar(255) [not null]
  token varchar(64) [unique, not null]
  abilities text [null]
  last_used_at timestamp [null]
  expires_at timestamp [null]
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  
  Indexes {
    (tokenable_type, tokenable_id) [name: 'idx_personal_access_tokens_tokenable']
    token [unique, name: 'idx_personal_access_tokens_token']
  }
  
  Note: 'API tokens for Sanctum authentication'
}

// Failed Login Attempts
Table failed_login_attempts {
  id bigserial [pk, increment]
  email varchar(255) [not null]
  ip_address inet [not null]
  user_agent text [null]
  attempted_at timestamp [default: `now()`]
  
  Indexes {
    email [name: 'idx_failed_login_email']
    ip_address [name: 'idx_failed_login_ip']
    attempted_at [name: 'idx_failed_login_attempted']
  }
  
  Note: 'Track failed login attempts for security'
}

// Password Reset Tokens
Table password_reset_tokens {
  email varchar(255) [pk]
  token varchar(255) [not null]
  created_at timestamp [default: `now()`]
  
  Indexes {
    email [name: 'idx_password_reset_email']
  }
  
  Note: 'Password reset tokens'
}

// Relationships
Ref: layers.created_by > users.id [delete: cascade]
Ref: audit_logs.user_id > users.id [delete: set null]
Ref: sessions.user_id > users.id [delete: cascade]

// Views
// View for active layers with creator info
TableGroup "Layer Management" {
  layers
  users
  audit_logs
}

TableGroup "Authentication & Authorization" {
  users
  roles
  permissions
  model_has_roles
  model_has_permissions
  role_has_permissions
  sessions
  personal_access_tokens
  failed_login_attempts
  password_reset_tokens
}

TableGroup "Security & Audit" {
  audit_logs
  failed_login_attempts
  sessions
}

